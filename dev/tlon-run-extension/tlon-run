#!/usr/bin/env bash
set -euo pipefail

# tlon-run: TlonBot management tool
#
# Provides two capabilities:
# 1. Workspace file management (SOUL.md, USER.md, etc.)
# 2. Click operations (ship ops via khan threads)

# Workspace file commands
WORKSPACE_CMDS="soul user tools agents bootstrap heartbeat identity memory scratchpad"

is_workspace_cmd() {
  local cmd="$1"
  for w in $WORKSPACE_CMDS; do
    [ "$cmd" = "$w" ] && return 0
  done
  return 1
}

resolve_workspace_file() {
  local name="$1"
  [[ "$name" =~ ^[A-Za-z][A-Za-z0-9_-]*$ ]] || { echo "error: invalid file name '$name'" >&2; exit 2; }
  [ -n "${WORKSPACE_DIR:-}" ] || { echo "error: WORKSPACE_DIR not set" >&2; exit 2; }
  [ -d "$WORKSPACE_DIR" ] || { echo "error: workspace not found: $WORKSPACE_DIR" >&2; exit 2; }
  echo "$WORKSPACE_DIR/${name}.md"
}

handle_workspace_cmd() {
  local cmd="$1"
  shift
  local file_name
  file_name="$(echo "$cmd" | tr '[:lower:]' '[:upper:]')"
  local target
  target="$(resolve_workspace_file "$file_name")"
  local sub="${1:-}"
  shift || true

  read_content() {
    if [ $# -gt 0 ] && [ -n "$1" ] && [ "$1" != "-" ]; then
      printf '%s' "$1"
    elif ! [ -t 0 ]; then
      cat
    else
      echo "error: missing content (pass as argument or pipe via stdin)" >&2
      exit 2
    fi
  }

  case "$sub" in
    read)
      [ -f "$target" ] && cat "$target" || echo "(empty)"
      ;;
    replace)
      local content
      content="$(read_content "${1:-}")"
      [ -n "$content" ] || { echo "error: empty content"; exit 2; }
      printf '%s\n' "$content" > "$target"
      echo "ok: replaced ${file_name}.md"
      ;;
    append)
      local content
      content="$(read_content "${1:-}")"
      [ -n "$content" ] || { echo "error: empty content"; exit 2; }
      printf '\n%s\n' "$content" >> "$target"
      echo "ok: appended to ${file_name}.md"
      ;;
    *)
      echo "error: unknown subcommand '$sub'"
      echo "usage: tlon-run $cmd {read|replace|append} [content | -]"
      exit 2
      ;;
  esac
}

# Click helpers
validate_ship() {
  local ship="$1"
  [[ "$ship" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}$ ]] || { echo "error: invalid ship name '$ship'"; exit 2; }
}

validate_group() {
  local grp="$1"
  [[ "$grp" =~ ^~[a-z]{3,6}(-[a-z]{6}){0,3}/[a-z0-9-]+$ ]] || { echo "error: invalid group '$grp'"; exit 2; }
}

validate_desk() {
  local desk="$1"
  [[ "$desk" =~ ^[a-z][a-z0-9-]*$ ]] || { echo "error: invalid desk name '$desk'"; exit 2; }
}

validate_agent() {
  local agent="$1"
  [[ "$agent" =~ ^[a-z][a-z0-9-]*$ ]] || { echo "error: invalid agent name '$agent'"; exit 2; }
}

format_as_cell() {
  local flag="$1"
  local ship="${flag%%/*}"
  local name="${flag#*/}"
  echo "[${ship} %${name}]"
}

get_pier_path() {
  local ship_file="$1"
  local pier
  pier="$(node -e "process.stdout.write(JSON.parse(require('fs').readFileSync('$ship_file','utf8')).pierPath||'')")"
  [ -n "$pier" ] || { echo "error: no pierPath in ship config $ship_file"; exit 2; }
  echo "$pier"
}

run_click() {
  local pier="$1"
  local hoon="$2"
  [ -d "$pier" ] || { echo "error: pier not found at $pier"; exit 2; }
  exec click -k "$pier" "$hoon"
}

handle_click() {
  local op="${1:-}"
  shift || true

  # Need ship config for pier path
  local skill_dir="${TLON_SKILL_DIR:-$HOME/.openclaw/skills/tlon}"
  local ship_name="${TLON_SHIP:-}"

  # Auto-detect ship if not specified
  if [ -z "$ship_name" ]; then
    local ships_dir="$skill_dir/ships"
    if [ -d "$ships_dir" ]; then
      for f in "$ships_dir"/*.json; do
        [ -f "$f" ] || continue
        [ "$(basename "$f")" = "example.json" ] && continue
        ship_name="$(basename "$f" .json)"
        break
      done
    fi
  fi
  [ -n "$ship_name" ] || { echo "error: no ship config found. Set TLON_SHIP or add config to $skill_dir/ships/"; exit 2; }

  local ship_file="$skill_dir/ships/${ship_name#\~}.json"
  [ -f "$ship_file" ] || { echo "error: ship config not found: $ship_file"; exit 2; }

  local pier
  pier="$(get_pier_path "$ship_file")"

  case "$op" in
    # --- System ---
    get-code)
      run_click "$pier" $'=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  code=@p  bind:m  (scry @p /j/code/(scot %p our))  (pure:m !>((crip (slag 1 (scow %p code)))))'
      ;;
    get-vats)
      run_click "$pier" $'=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  now=@da  bind:m  get-time  (pure:m !>((report-vats our now [%kids ~] %exists &)))'
      ;;
    bump)
      run_click "$pier" $'=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-bump !>(~))  (pure:m !>(~))'
      ;;
    ota)
      local local_desk="${1:-}" remote_desk="${2:-}" source="${3:-}"
      [ -n "$local_desk" ] || { echo "error: missing local desk"; echo "usage: tlon-run click ota <local-desk> <remote-desk> ~source-ship"; exit 2; }
      [ -n "$remote_desk" ] || { echo "error: missing remote desk"; exit 2; }
      [ -n "$source" ] || { echo "error: missing source ship"; exit 2; }
      validate_desk "$local_desk"; validate_desk "$remote_desk"; validate_ship "$source"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  ~  bind:m  (poke [our %hood] %kiln-install !>([%${local_desk} ${source} %${remote_desk}]))  (pure:m !>(\\\'success\\\'))"
      ;;
    commit)
      local desk="${1:-}"
      [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click commit <desk>"; exit 2; }
      validate_desk "$desk"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-commit !>([[%${desk}] %.n]))  (pure:m !>(~))"
      ;;
    mount)
      local desk="${1:-}"
      [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click mount <desk>"; exit 2; }
      validate_desk "$desk"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  now=@da  bind:m  get-time  ;<  ~  bind:m  (poke-our %hood %kiln-mount !>([(en-beam [our %${desk} [%da now]] /) %${desk}]))  (pure:m !>(~))"
      ;;
    unmount)
      local desk="${1:-}"
      [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click unmount <desk>"; exit 2; }
      validate_desk "$desk"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  ~  bind:m  (poke-our %hood %kiln-unmount !>(%${desk}))  (pure:m !>(~))"
      ;;
    revive)
      local desk="${1:-}"
      [ -n "$desk" ] || { echo "error: missing desk name"; echo "usage: tlon-run click revive <desk>"; exit 2; }
      validate_desk "$desk"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  ~  bind:m  (poke [our %hood] %kiln-revive !>(${desk}))  (pure:m !>(~))"
      ;;
    merge-remote)
      local source="${1:-}" src_desk="${2:-}" dst_desk="${3:-}"
      [ -n "$source" ] || { echo "error: missing source ship"; echo "usage: tlon-run click merge-remote ~source-ship <src-desk> <dst-desk>"; exit 2; }
      [ -n "$src_desk" ] || { echo "error: missing source desk"; exit 2; }
      [ -n "$dst_desk" ] || { echo "error: missing destination desk"; exit 2; }
      validate_ship "$source"; validate_desk "$src_desk"; validate_desk "$dst_desk"
      run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ~&  \\\'Merging ${source}/${src_desk} into ${dst_desk}\\\'  =/  src-ship  ${source}  =/  src-desk  ${src_desk}  =/  dst-desk  ${dst_desk}  ;<  now=@da  bind:m  get-time  =/  kiln-merge  [dst-desk src-ship src-desk [%da now] %only-that]  ;<  ~  bind:m  (poke-our %hood %kiln-merge !>(kiln-merge))  (pure:m !>(~))"
      ;;
    merge-to-kids)
      run_click "$pier" $'=/  m  (strand ,vase)  ^-  form:m  ;<  our=@p  bind:m  get-our  =/  src-desk  %base  =/  dst-desk  %kids  ;<  now=@da  bind:m  get-time  =/  kiln-merge  [dst-desk our src-desk [%da now] %only-that]  ;<  ~  bind:m  (poke-our %hood %kiln-merge !>(kiln-merge))  (pure:m !>(~))'
      ;;
    is-agent-running)
      local agent="${1:-}"
      [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click is-agent-running <agent>"; exit 2; }
      validate_agent "$agent"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  a=?  bind:m  (scry ? /gu/${agent}/\$)  (pure:m !>(a))"
      ;;
    moon-key)
      local moon="${1:-}"
      [ -n "$moon" ] || { echo "error: missing moon prefix"; echo "usage: tlon-run click moon-key <moon-prefix>"; exit 2; }
      [[ "$moon" =~ ^[a-z]{6}$ ]] || { echo "error: invalid moon prefix '$moon' (expected 6 lowercase letters)"; exit 2; }
      local planet
      planet="$(node -e "process.stdout.write(JSON.parse(require('fs').readFileSync('$ship_file','utf8')).ship||'')")"
      [ -n "$planet" ] || { echo "error: no ship name in config $ship_file"; exit 2; }
      run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ;<  bowl=bowl:spider  bind:m  get-bowl  =/  mon=ship  ~${moon}-${planet#\~}  =/  cub  (pit:nu:crub:crypto 512 (shaz (jam mon life=1 eny.bowl)))  =/  =feed:jael  [[%2 ~] mon rift=0 [life=1 sec:ex:cub]~]  =/  =pass  pub:ex:cub  =/  udif=udiff:point:jael  [*id:block:jael %keys [1 1 pass] %.n]  ;<  ~  bind:m  (poke [our.bowl %hood] %helm-moon !>(\`[mon udif]))  (pure:m !>((crip (scow %uw (jam feed)))))"
      ;;
    get-remote-hash)
      local source="${1:-}" desk="${2:-}"
      [ -n "$source" ] || { echo "error: missing source ship"; echo "usage: tlon-run click get-remote-hash ~source-ship <desk>"; exit 2; }
      [ -n "$desk" ] || { echo "error: missing desk name"; exit 2; }
      validate_ship "$source"; validate_desk "$desk"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  now=@da  bind:m  get-time  ;<  r=riot:clay  bind:m  (warp ${source} %${desk} ~ %sing %z da+now /)  ?~(r (pure:m !>(~)) (pure:m q.r.u.r))"
      ;;
    dump-agent-eggs)
      local agent="${1:-}"
      [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click dump-agent-eggs <agent>"; exit 2; }
      validate_agent "$agent"
      run_click "$pier" "=/  m  (strand ,vase)  ;<  our=@p  bind:m  get-our  ;<  a=egg-any:gall  bind:m  (scry egg-any:gall /gv/${agent}/\$)  ;<  ~  bind:m  (poke [our %hood] %drum-put !>([/${agent}/jam (jam ?>(?=(%live +<.a) a(p.old-state -:!>(**))))]))  (pure:m !>(~))"
      ;;
    load-agent-eggs)
      local agent="${1:-}"
      [ -n "$agent" ] || { echo "error: missing agent name"; echo "usage: tlon-run click load-agent-eggs <agent>"; exit 2; }
      validate_agent "$agent"
      run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  ;<  egg=@  bind:m  (scry @ /cx/base/bak/${agent}/jam)  ;<  our=@p  bind:m  get-our  =/  dk=dock  [our %${agent}]  =/  cg=cage  [%noun !>((cue egg))]  =/  =card:agent:gall  [%pass /pokeas %agent dk %poke %egg-any -:!>(*egg-any:gall) (cue egg)]  ;<  ~  bind:m  (send-raw-card card)  ;<  ~  bind:m  (take-poke-ack /pokeas)  (pure:m !>(~))"
      ;;

    # --- Groups ---
    force-join)
      local grp="${1:-}"
      [ -n "$grp" ] || { echo "error: missing group flag"; echo "usage: tlon-run click force-join ~host/group-name"; exit 2; }
      validate_group "$grp"
      local flag
      flag="$(format_as_cell "$grp")"
      run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  =/  flag  ${flag}  ;<  ~  bind:m  (poke-our %groups %group-foreign-1 !>([%foreign flag [%join ~]]))  (pure:m !>(~))"
      ;;
    force-join-token)
      local grp="${1:-}" token="${2:-}"
      [ -n "$grp" ] || { echo "error: missing group flag"; echo "usage: tlon-run click force-join-token ~host/group-name <token>"; exit 2; }
      [ -n "$token" ] || { echo "error: missing token"; exit 2; }
      validate_group "$grp"
      local flag
      flag="$(format_as_cell "$grp")"
      run_click "$pier" "=/  m  (strand ,vase)  ^-  form:m  =/  flag  ${flag}  ;<  ~  bind:m  (poke-our %groups %group-foreign-1 !>([%foreign flag [%join (some ${token})]]))  (pure:m !>(~))"
      ;;

    # --- Raw Hoon ---
    eval)
      local hoon="${1:-}"
      [ -n "$hoon" ] || { echo "error: missing hoon thread"; echo "usage: tlon-run click eval '<hoon thread string>'"; exit 2; }
      run_click "$pier" "$hoon"
      ;;

    ""|help|--help|-h)
      cat <<'EOF'
tlon-run click: Ship operations via khan threads

Usage: tlon-run click <operation> [args...]

System Operations:
  get-code                              Get ship access code
  get-vats                              Get installed desk versions
  bump                                  Force OTA check
  ota <local> <remote> ~source          OTA update a desk
  commit <desk>                         Commit desk changes
  mount <desk>                          Mount a desk
  unmount <desk>                        Unmount a desk
  revive <desk>                         Revive suspended desk
  merge-remote ~src <src-desk> <dst>    Merge remote desk
  merge-to-kids                         Merge %base into %kids
  is-agent-running <agent>              Check agent (0=yes, 1=no)
  moon-key <prefix>                     Get moon boot key
  get-remote-hash ~src <desk>           Get desk hash
  dump-agent-eggs <agent>               Dump agent state
  load-agent-eggs <agent>               Load agent state

Group Operations:
  force-join ~host/group                Force join a group
  force-join-token ~host/group <token>  Join with invite token

Raw Hoon:
  eval '<hoon thread>'                  Run arbitrary Hoon
EOF
      exit 0
      ;;
    *)
      echo "error: unknown click operation '$op'"
      echo "Run 'tlon-run click --help' for usage."
      exit 2
      ;;
  esac
}

print_help() {
  cat <<'EOF'
tlon-run: TlonBot skill for managing workspace and running click operations

Usage: tlon-run [options] <command> [args...]

This tool allows workspace file management and click operations for managing
the OpenClaw bot and its associated ships.

Workspace Commands:
  soul {read|replace|append} [content]      Edit SOUL.md
  user {read|replace|append} [content]      Edit USER.md
  tools {read|replace|append} [content]     Edit TOOLS.md
  agents {read|replace|append} [content]    Edit AGENTS.md
  bootstrap {read|replace|append} [content] Edit BOOTSTRAP.md
  heartbeat {read|replace|append} [content] Edit HEARTBEAT.md
  identity {read|replace|append} [content]  Edit IDENTITY.md
  memory {read|replace|append} [content]    Edit MEMORY.md
  scratchpad {read|replace|append} [content] Edit SCRATCHPAD.md

Click Commands (ship operations):
  click <operation> [args...]           Run click operations
  click --help                          Show click help

Examples:
  tlon-run soul read
  tlon-run soul replace "New soul content"
  tlon-run click get-code
EOF
}

# Main entry point
main() {
  # Handle help
  case "${1:-}" in
    ""|--help|-h|help)
      print_help
      exit 0
      ;;
  esac

  # Check for workspace commands
  if is_workspace_cmd "${1:-}"; then
    handle_workspace_cmd "$@"
    exit 0
  fi

  # Check for click command
  if [ "${1:-}" = "click" ]; then
    shift
    handle_click "$@"
    exit 0
  fi

  # Unknown command
  echo "error: unknown command '${1:-}'"
  echo "Run 'tlon-run --help' for usage."
  exit 2
}

main "$@"
