services:
  # Both fakezod ships in one container (they need shared fake ames)
  ships:
    image: ubuntu:22.04
    command:
      - bash
      - -c
      - |
        apt-get update && apt-get install -y curl xz-utils
        cd /data
        
        # Download and extract zod
        if [ ! -f rube-zod23.tgz ]; then
          curl -sL https://bootstrap.urbit.org/rube-zod23.tgz -o rube-zod23.tgz
        fi
        tar xzf rube-zod23.tgz
        
        # Download and extract bus
        if [ ! -f rube-bus9.tgz ]; then
          curl -sL https://bootstrap.urbit.org/rube-bus9.tgz -o rube-bus9.tgz
        fi
        tar xzf rube-bus9.tgz
        
        # Get vere
        curl -sL https://urbit.org/install/linux-x86_64/latest | tar xz
        VERE=$$(ls -1 vere-*-linux-x86_64 | head -1)
        chmod +x $$VERE
        
        # Start both ships (background zod, foreground bus)
        ./$$VERE -t --loom 31 --http-port 8080 zod &
        ./$$VERE -t --loom 31 --http-port 8081 bus
    volumes:
      - ships-data:/data
    ports:
      - "8080:8080"
      - "8081:8081"

  # OpenClaw gateway with plugin
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile.ci
    environment:
      - TLON_URL=http://ships:8080
      - TLON_SHIP=~zod
      - TLON_CODE=lidlut-tabwed-pillex-ridrup
      - TLON_DM_ALLOWLIST=~bus
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENCLAW_MODEL=openrouter/minimax/minimax-m2.1
    ports:
      - "18789:18789"
    volumes:
      - ..:/workspace/openclaw-tlon
      - openclaw-modules:/workspace/openclaw-tlon/node_modules

volumes:
  ships-data:
  openclaw-modules:
