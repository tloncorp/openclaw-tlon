services:
  # Fakezod (bot ship)
  zod:
    image: ubuntu:22.04
    command:
      - bash
      - -c
      - |
        apt-get update && apt-get install -y curl xz-utils
        cd /data
        if [ ! -f rube-zod23.tgz ]; then
          curl -sL https://bootstrap.urbit.org/rube-zod23.tgz -o rube-zod23.tgz
        fi
        tar xzf rube-zod23.tgz
        curl -sL https://urbit.org/install/linux-x86_64/latest | tar xz
        VERE=$$(ls -1 vere-*-linux-x86_64 | head -1)
        chmod +x $$VERE
        ./$$VERE -t --loom 31 --http-port 8080 zod
    volumes:
      - zod-data:/data
    ports:
      - "8080:8080"

  # Fakeship (test user)
  bus:
    image: ubuntu:22.04
    command:
      - bash
      - -c
      - |
        apt-get update && apt-get install -y curl xz-utils
        cd /data
        if [ ! -f rube-bus9.tgz ]; then
          curl -sL https://bootstrap.urbit.org/rube-bus9.tgz -o rube-bus9.tgz
        fi
        tar xzf rube-bus9.tgz
        curl -sL https://urbit.org/install/linux-x86_64/latest | tar xz
        VERE=$$(ls -1 vere-*-linux-x86_64 | head -1)
        chmod +x $$VERE
        ./$$VERE -t --loom 31 --http-port 8080 bus
    volumes:
      - bus-data:/data
    ports:
      - "8081:8080"

  # OpenClaw gateway with plugin
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile.ci
    environment:
      - TLON_URL=http://zod:8080
      - TLON_SHIP=~zod
      - TLON_CODE=lidlut-tabwed-pillex-ridrup
      - TLON_DM_ALLOWLIST=~bus
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENCLAW_MODEL=openrouter/minimax/minimax-m2.1
    ports:
      - "18789:18789"
    volumes:
      - ..:/workspace/openclaw-tlon
      - openclaw-modules:/workspace/openclaw-tlon/node_modules

volumes:
  zod-data:
  bus-data:
  openclaw-modules:
