services:
  # Both fakezod ships in one container (they need shared fake ames)
  ships:
    image: ubuntu:22.04
    command:
      - bash
      - -c
      - |
        set -e
        apt-get update && apt-get install -y curl xz-utils
        cd /data

        echo "==> Downloading zod..."
        curl -fSL https://bootstrap.urbit.org/rube-zod23.tgz -o rube-zod23.tgz || { echo "Failed to download zod"; exit 1; }
        ls -la rube-zod23.tgz
        echo "==> Extracting zod..."
        tar xzf rube-zod23.tgz || { echo "Failed to extract zod"; exit 1; }

        echo "==> Downloading ten..."
        curl -fSL https://bootstrap.urbit.org/rube-ten23.tgz -o rube-ten23.tgz || { echo "Failed to download ten"; exit 1; }
        ls -la rube-ten23.tgz
        echo "==> Extracting ten..."
        tar xzf rube-ten23.tgz || { echo "Failed to extract ten"; exit 1; }

        echo "==> Downloading vere..."
        curl -fSL https://urbit.org/install/linux-x86_64/latest | tar xz || { echo "Failed to download vere"; exit 1; }
        VERE=$$(ls -1 vere-*-linux-x86_64 | head -1)
        chmod +x $$VERE
        echo "==> Using vere: $$VERE"

        echo "==> Starting ships..."
        ./$$VERE -t --loom 31 --http-port 8080 zod &
        ./$$VERE -t --loom 31 --http-port 8081 ten
    volumes:
      - ships-data:/data
    ports:
      - "8080:8080"
      - "8081:8081"

  # OpenClaw gateway with plugin
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - TLON_URL=http://ships:8080
      - TLON_SHIP=~zod
      - TLON_CODE=lidlut-tabwed-pillex-ridrup
      - TLON_DM_ALLOWLIST=~ten
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENCLAW_MODEL=openrouter/minimax/minimax-m2.1
      - TLONBOT_TOKEN=${TLONBOT_TOKEN}
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
    volumes:
      - ..:/workspace/openclaw-tlon
      - openclaw-modules:/workspace/openclaw-tlon/node_modules

volumes:
  ships-data:
  openclaw-modules:
