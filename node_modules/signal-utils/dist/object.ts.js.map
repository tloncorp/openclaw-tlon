{"version":3,"file":"object.ts.js","sources":["../src/object.ts"],"sourcesContent":["import { Signal } from \"signal-polyfill\";\nimport { createStorage } from \"./-private/util.ts\";\n\n/**\n * Implementation based of tracked-built-ins' TrackedObject\n * https://github.com/tracked-tools/tracked-built-ins/blob/master/addon/src/-private/object.js\n */\nexport class SignalObjectImpl {\n  static fromEntries<T = unknown>(\n    entries: Iterable<readonly [PropertyKey, T]>,\n  ) {\n    return new SignalObjectImpl(Object.fromEntries(entries)) as T;\n  }\n  #storages = new Map<PropertyKey, Signal.State<null>>();\n  #collection = createStorage();\n\n  constructor(obj = {}) {\n    let proto = Object.getPrototypeOf(obj);\n    let descs = Object.getOwnPropertyDescriptors(obj);\n\n    let clone = Object.create(proto);\n\n    for (let prop in descs) {\n      // SAFETY: we just iterated over the property, so having to do an\n      //         existence check here is a little silly\n      Object.defineProperty(clone, prop, descs[prop]!);\n    }\n\n    let self = this;\n\n    return new Proxy(clone, {\n      get(target, prop, receiver) {\n        // we don't use the signals directly\n        // because we don't know (nor care!) what the value would be\n        // and the value could be replaced\n        // (this is also important for supporting getters)\n        self.#readStorageFor(prop);\n\n        return Reflect.get(target, prop, receiver);\n      },\n\n      has(target, prop) {\n        self.#readStorageFor(prop);\n\n        return prop in target;\n      },\n\n      ownKeys(target) {\n        self.#collection.get();\n\n        return Reflect.ownKeys(target);\n      },\n\n      set(target, prop, value, receiver) {\n        let result = Reflect.set(target, prop, value, receiver);\n\n        self.#dirtyStorageFor(prop);\n        self.#dirtyCollection();\n\n        return result;\n      },\n\n      deleteProperty(target, prop) {\n        if (prop in target) {\n          delete target[prop];\n          self.#dirtyStorageFor(prop);\n          self.#dirtyCollection();\n        }\n\n        return true;\n      },\n\n      getPrototypeOf() {\n        return SignalObjectImpl.prototype;\n      },\n    });\n  }\n\n  #readStorageFor(key: PropertyKey) {\n    let storage = this.#storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage();\n      this.#storages.set(key, storage);\n    }\n\n    storage.get();\n  }\n\n  #dirtyStorageFor(key: PropertyKey) {\n    const storage = this.#storages.get(key);\n\n    if (storage) {\n      storage.set(null);\n    }\n  }\n\n  #dirtyCollection() {\n    this.#collection.set(null);\n  }\n}\n\ninterface SignalObject {\n  fromEntries<T = unknown>(\n    entries: Iterable<readonly [PropertyKey, T]>,\n  ): { [k: string]: T };\n\n  new <T extends Record<PropertyKey, unknown> = Record<PropertyKey, unknown>>(\n    obj?: T,\n  ): T;\n}\n// Types are too hard in proxy-implementation\n// we want TS to think the SignalObject is Object-like\n\n/**\n * Create a reactive Object, backed by Signals, using a Proxy.\n * This allows dynamic creation and deletion of signals using the object primitive\n * APIs that most folks are familiar with -- the only difference is instantiation.\n * ```js\n * const obj = new SignalObject({ foo: 123 });\n *\n * obj.foo // 123\n * obj.foo = 456\n * obj.foo // 456\n * obj.bar = 2\n * obj.bar // 2\n * ```\n */\nexport const SignalObject: SignalObject =\n  SignalObjectImpl as unknown as SignalObject;\n\nexport function signalObject<T extends Record<PropertyKey, unknown>>(\n  obj?: T | undefined,\n) {\n  return new SignalObject(obj);\n}\n"],"names":["SignalObjectImpl","fromEntries","entries","Object","Map","createStorage","constructor","obj","proto","getPrototypeOf","descs","getOwnPropertyDescriptors","clone","create","prop","defineProperty","self","Proxy","get","target","receiver","Reflect","has","ownKeys","set","value","result","deleteProperty","prototype","#readStorageFor","key","storage","undefined","#dirtyStorageFor","#dirtyCollection","SignalObject","signalObject"],"mappings":"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"}