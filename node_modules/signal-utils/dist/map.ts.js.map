{"version":3,"file":"map.ts.js","sources":["../src/map.ts"],"sourcesContent":["import { createStorage, type StorageMap } from \"./-private/util.ts\";\n\nexport class SignalMap<K = unknown, V = unknown> implements Map<K, V> {\n  private collection = createStorage();\n\n  private storages: StorageMap<K> = new Map();\n\n  private vals: Map<K, V>;\n\n  private readStorageFor(key: K): void {\n    const { storages } = this;\n    let storage = storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage();\n      storages.set(key, storage);\n    }\n\n    storage.get();\n  }\n\n  private dirtyStorageFor(key: K): void {\n    const storage = this.storages.get(key);\n\n    if (storage) {\n      storage.set(null);\n    }\n  }\n\n  constructor();\n  constructor(entries: readonly (readonly [K, V])[] | null);\n  constructor(iterable: Iterable<readonly [K, V]>);\n  constructor(\n    existing?:\n      | readonly (readonly [K, V])[]\n      | Iterable<readonly [K, V]>\n      | null\n      | undefined,\n  ) {\n    // TypeScript doesn't correctly resolve the overloads for calling the `Map`\n    // constructor for the no-value constructor. This resolves that.\n    this.vals = existing ? new Map(existing) : new Map();\n  }\n\n  // **** KEY GETTERS ****\n  get(key: K): V | undefined {\n    // entangle the storage for the key\n    this.readStorageFor(key);\n\n    return this.vals.get(key);\n  }\n\n  has(key: K): boolean {\n    this.readStorageFor(key);\n\n    return this.vals.has(key);\n  }\n\n  // **** ALL GETTERS ****\n  entries(): IterableIterator<[K, V]> {\n    this.collection.get();\n\n    return this.vals.entries();\n  }\n\n  keys(): IterableIterator<K> {\n    this.collection.get();\n\n    return this.vals.keys();\n  }\n\n  values(): IterableIterator<V> {\n    this.collection.get();\n\n    return this.vals.values();\n  }\n\n  forEach(fn: (value: V, key: K, map: Map<K, V>) => void): void {\n    this.collection.get();\n\n    this.vals.forEach(fn);\n  }\n\n  get size(): number {\n    this.collection.get();\n\n    return this.vals.size;\n  }\n\n  [Symbol.iterator](): IterableIterator<[K, V]> {\n    this.collection.get();\n\n    return this.vals[Symbol.iterator]();\n  }\n\n  get [Symbol.toStringTag](): string {\n    return this.vals[Symbol.toStringTag];\n  }\n\n  // **** KEY SETTERS ****\n  set(key: K, value: V): this {\n    this.dirtyStorageFor(key);\n    this.collection.set(null);\n\n    this.vals.set(key, value);\n\n    return this;\n  }\n\n  delete(key: K): boolean {\n    this.dirtyStorageFor(key);\n    this.collection.set(null);\n\n    return this.vals.delete(key);\n  }\n\n  // **** ALL SETTERS ****\n  clear(): void {\n    this.storages.forEach((s) => s.set(null));\n    this.collection.set(null);\n\n    this.vals.clear();\n  }\n}\n\n// So instanceof works\nObject.setPrototypeOf(SignalMap.prototype, Map.prototype);\n"],"names":["SignalMap","collection","createStorage","storages","Map","vals","readStorageFor","key","storage","get","undefined","set","dirtyStorageFor","constructor","existing","has","entries","keys","values","forEach","fn","size","Symbol","iterator","toStringTag","value","delete","clear","s","Object","setPrototypeOf","prototype"],"mappings":"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"}