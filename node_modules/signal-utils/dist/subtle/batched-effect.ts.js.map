{"version":3,"file":"batched-effect.ts.js","sources":["../../src/subtle/batched-effect.ts"],"sourcesContent":["import { Signal } from \"signal-polyfill\";\n\nconst notifiedEffects = new Set<{\n  computed: Signal.Computed<void>;\n  watcher: Signal.subtle.Watcher;\n}>();\n\nlet batchDepth = 0;\n\n/**\n * Runs the given function inside of a \"batch\" and calls any batched effects\n * (those created with `batchEffect()`) that depend on updated signals\n * synchronously after the function completes.\n *\n * Batches can be nested, and effects will only be called once at the end of the\n * outermost batch.\n *\n * Batching does not change how the signal graph updates, or change any other\n * watcher or effect system. Accessing signals that are updated within a batch\n * will return their updates value. Other computations, watcher, and effects\n * created outside of a batch that depend on updated signals will be run as\n * usual.\n *\n * @param fn The function to run inside the batch.\n */\nexport const batch = (fn: () => void) => {\n  batchDepth++;\n  try {\n    // Run the function to notifiy watchers\n    fn();\n  } finally {\n    batchDepth--;\n\n    if (batchDepth !== 0) {\n      return;\n    }\n\n    // Copy then clear the notified effects\n    const effects = [...notifiedEffects];\n    notifiedEffects.clear();\n\n    // Run all the batched effect callbacks and re-enable the watchers\n    let exceptions!: any[];\n\n    for (const { computed, watcher } of effects) {\n      watcher.watch(computed);\n      try {\n        computed.get();\n      } catch (e) {\n        (exceptions ??= []).push(e);\n      }\n    }\n\n    if (exceptions !== undefined) {\n      if (exceptions.length === 1) {\n        throw exceptions![0];\n      } else {\n        throw new AggregateError(\n          exceptions!,\n          \"Multiple exceptions thrown in batched effects\",\n        );\n      }\n    }\n  }\n};\n\n/**\n * Creates an effect that runs synchronously at the end of a `batch()` call if\n * any of the signals it depends on have been updated.\n *\n * The effect also runs asynchronously, on the microtask queue, if any of the\n * signals it depends on have been updated outside of a `batch()` call.\n *\n * @param effectFn The function to run as an effect.\n * @returns A function that stops and disposes the effect.\n */\nexport const batchedEffect = (effectFn: () => void) => {\n  const computed = new Signal.Computed(effectFn);\n  const watcher = new Signal.subtle.Watcher(async () => {\n    // Synchonously add the effect to the notified effects\n    notifiedEffects.add(entry);\n\n    // Check if our effect is still in the notified effects\n    await 0;\n\n    if (notifiedEffects.has(entry)) {\n      // If it is, then we call it async and remove it\n      notifiedEffects.delete(entry);\n      computed.get();\n    }\n  });\n  const entry = { computed, watcher };\n  watcher.watch(computed);\n  computed.get();\n  return () => {\n    watcher.unwatch(computed);\n    notifiedEffects.delete(entry);\n  };\n};\n"],"names":["notifiedEffects","Set","batchDepth","batch","fn","effects","clear","exceptions","computed","watcher","watch","get","e","push","undefined","length","AggregateError","batchedEffect","effectFn","Signal","Computed","subtle","Watcher","add","entry","has","delete","unwatch"],"mappings":";;AAEA,MAAMA,eAAe,GAAG,IAAIC,GAAG,EAG3B,CAAA;AAEJ,IAAIC,UAAU,GAAG,CAAC,CAAA;;AAElB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACaC,MAAAA,KAAK,GAAIC,EAAc,IAAK;AACvCF,EAAAA,UAAU,EAAE,CAAA;EACZ,IAAI;AACF;AACAE,IAAAA,EAAE,EAAE,CAAA;AACN,GAAC,SAAS;AACRF,IAAAA,UAAU,EAAE,CAAA;IAEZ,IAAIA,UAAU,KAAK,CAAC,EAAE;AACpB,MAAA,OAAA;AACF,KAAA;;AAEA;AACA,IAAA,MAAMG,OAAO,GAAG,CAAC,GAAGL,eAAe,CAAC,CAAA;IACpCA,eAAe,CAACM,KAAK,EAAE,CAAA;;AAEvB;AACA,IAAA,IAAIC,UAAkB,CAAA;AAEtB,IAAA,KAAK,MAAM;MAAEC,QAAQ;AAAEC,MAAAA,OAAAA;KAAS,IAAIJ,OAAO,EAAE;AAC3CI,MAAAA,OAAO,CAACC,KAAK,CAACF,QAAQ,CAAC,CAAA;MACvB,IAAI;QACFA,QAAQ,CAACG,GAAG,EAAE,CAAA;OACf,CAAC,OAAOC,CAAC,EAAE;AACV,QAAA,CAACL,UAAU,KAAK,EAAE,EAAEM,IAAI,CAACD,CAAC,CAAC,CAAA;AAC7B,OAAA;AACF,KAAA;IAEA,IAAIL,UAAU,KAAKO,SAAS,EAAE;AAC5B,MAAA,IAAIP,UAAU,CAACQ,MAAM,KAAK,CAAC,EAAE;QAC3B,MAAMR,UAAU,CAAE,CAAC,CAAC,CAAA;AACtB,OAAC,MAAM;AACL,QAAA,MAAM,IAAIS,cAAc,CACtBT,UAAU,EACV,+CACF,CAAC,CAAA;AACH,OAAA;AACF,KAAA;AACF,GAAA;AACF,EAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACaU,MAAAA,aAAa,GAAIC,QAAoB,IAAK;EACrD,MAAMV,QAAQ,GAAG,IAAIW,MAAM,CAACC,QAAQ,CAACF,QAAQ,CAAC,CAAA;EAC9C,MAAMT,OAAO,GAAG,IAAIU,MAAM,CAACE,MAAM,CAACC,OAAO,CAAC,YAAY;AACpD;AACAtB,IAAAA,eAAe,CAACuB,GAAG,CAACC,KAAK,CAAC,CAAA;;AAE1B;AACA,IAAA,MAAM,CAAC,CAAA;AAEP,IAAA,IAAIxB,eAAe,CAACyB,GAAG,CAACD,KAAK,CAAC,EAAE;AAC9B;AACAxB,MAAAA,eAAe,CAAC0B,MAAM,CAACF,KAAK,CAAC,CAAA;MAC7BhB,QAAQ,CAACG,GAAG,EAAE,CAAA;AAChB,KAAA;AACF,GAAC,CAAC,CAAA;AACF,EAAA,MAAMa,KAAK,GAAG;IAAEhB,QAAQ;AAAEC,IAAAA,OAAAA;GAAS,CAAA;AACnCA,EAAAA,OAAO,CAACC,KAAK,CAACF,QAAQ,CAAC,CAAA;EACvBA,QAAQ,CAACG,GAAG,EAAE,CAAA;AACd,EAAA,OAAO,MAAM;AACXF,IAAAA,OAAO,CAACkB,OAAO,CAACnB,QAAQ,CAAC,CAAA;AACzBR,IAAAA,eAAe,CAAC0B,MAAM,CAACF,KAAK,CAAC,CAAA;GAC9B,CAAA;AACH;;;;"}