{"version":3,"file":"reaction.ts.js","sources":["../../src/subtle/reaction.ts"],"sourcesContent":["import { Signal } from \"signal-polyfill\";\n\nexport const __internal_testing__ = {\n  active: false,\n  lastError: null,\n} as { active: boolean; lastError: null | unknown };\n\nclass ReactionError {\n  original: unknown;\n  name = \"ReactionError\";\n\n  constructor(original: unknown) {\n    this.original = original;\n  }\n}\n\n/**\n * Reactions are a way to observe a value and run an effect when it changes.\n *\n * The `data` function is run and tracked in a computed signal. It returns a\n * value that is compared to the previous value. If the value changes, the\n * `effect` function is called with the new value and the previous value.\n *\n * @param data A function that returns the value to observe.\n * @param effect A function that is called when the value changes.\n * @param equals A function that compares two values for equality.\n * @returns A function that stops the reaction.\n */\nexport const reaction = <T>(\n  data: () => T,\n  effect: (value: T, previousValue: T) => void,\n  equals = Object.is,\n) => {\n  // Passing equals here doesn't seem to dedupe the effect calls.\n  const computed: Signal.Computed<T> = new Signal.Computed(data, {\n    equals,\n  });\n  let previousValue = computed.get();\n  let notify: (() => Promise<void>) | undefined = async () => {\n    // await 0 is a cheap way to queue a microtask\n    await 0;\n    // Check if this reaction was unsubscribed\n    if (notify === undefined) {\n      return;\n    }\n    const value = computed.get();\n    if (!equals(value, previousValue)) {\n      try {\n        effect(value, previousValue);\n      } catch (e) {\n        // TODO: we actually want this to be unhandled, but Vitest complains.\n        // We probably don't want to enable dangerouslyIgnoreUnhandledErrors\n        // for all tests\n        if (__internal_testing__) {\n          console.error(e);\n          __internal_testing__.lastError = e;\n        } else {\n          throw new ReactionError(e);\n        }\n      } finally {\n        previousValue = value;\n      }\n    }\n    watcher.watch();\n  };\n  const watcher = new Signal.subtle.Watcher(() => notify?.());\n  watcher.watch(computed);\n\n  return () => {\n    watcher.unwatch(computed);\n    // TODO: Do we need this? Add a memory leak test.\n    // By severing the reference to the notify function, we allow the garbage\n    // collector to clean up the resources used by the watcher.\n    notify = undefined;\n  };\n};\n"],"names":["__internal_testing__","active","lastError","ReactionError","original","name","constructor","reaction","data","effect","equals","Object","is","computed","Signal","Computed","previousValue","get","notify","undefined","value","e","console","error","watcher","watch","subtle","Watcher","unwatch"],"mappings":";;AAEO,MAAMA,oBAAoB,GAAG;AAClCC,EAAAA,MAAM,EAAE,KAAK;AACbC,EAAAA,SAAS,EAAE,IAAA;AACb,EAAmD;AAEnD,MAAMC,aAAa,CAAC;EAClBC,QAAQ,CAAA;AACRC,EAAAA,IAAI,GAAG,eAAe,CAAA;EAEtBC,WAAWA,CAACF,QAAiB,EAAE;IAC7B,IAAI,CAACA,QAAQ,GAAGA,QAAQ,CAAA;AAC1B,GAAA;AACF,CAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACaG,MAAAA,QAAQ,GAAGA,CACtBC,IAAa,EACbC,MAA4C,EAC5CC,MAAM,GAAGC,MAAM,CAACC,EAAE,KACf;AACH;EACA,MAAMC,QAA4B,GAAG,IAAIC,MAAM,CAACC,QAAQ,CAACP,IAAI,EAAE;AAC7DE,IAAAA,MAAAA;AACF,GAAC,CAAC,CAAA;AACF,EAAA,IAAIM,aAAa,GAAGH,QAAQ,CAACI,GAAG,EAAE,CAAA;AAClC,EAAA,IAAIC,MAAyC,GAAG,YAAY;AAC1D;AACA,IAAA,MAAM,CAAC,CAAA;AACP;IACA,IAAIA,MAAM,KAAKC,SAAS,EAAE;AACxB,MAAA,OAAA;AACF,KAAA;AACA,IAAA,MAAMC,KAAK,GAAGP,QAAQ,CAACI,GAAG,EAAE,CAAA;AAC5B,IAAA,IAAI,CAACP,MAAM,CAACU,KAAK,EAAEJ,aAAa,CAAC,EAAE;MACjC,IAAI;AACFP,QAAAA,MAAM,CAACW,KAAK,EAAEJ,aAAa,CAAC,CAAA;OAC7B,CAAC,OAAOK,CAAC,EAAE;AACV;AACA;AACA;AACA,QAAA,IAAIrB,oBAAoB,EAAE;AACxBsB,UAAAA,OAAO,CAACC,KAAK,CAACF,CAAC,CAAC,CAAA;UAChBrB,oBAAoB,CAACE,SAAS,GAAGmB,CAAC,CAAA;AACpC,SAAC,MAAM;AACL,UAAA,MAAM,IAAIlB,aAAa,CAACkB,CAAC,CAAC,CAAA;AAC5B,SAAA;AACF,OAAC,SAAS;AACRL,QAAAA,aAAa,GAAGI,KAAK,CAAA;AACvB,OAAA;AACF,KAAA;IACAI,OAAO,CAACC,KAAK,EAAE,CAAA;GAChB,CAAA;AACD,EAAA,MAAMD,OAAO,GAAG,IAAIV,MAAM,CAACY,MAAM,CAACC,OAAO,CAAC,MAAMT,MAAM,IAAI,CAAC,CAAA;AAC3DM,EAAAA,OAAO,CAACC,KAAK,CAACZ,QAAQ,CAAC,CAAA;AAEvB,EAAA,OAAO,MAAM;AACXW,IAAAA,OAAO,CAACI,OAAO,CAACf,QAAQ,CAAC,CAAA;AACzB;AACA;AACA;AACAK,IAAAA,MAAM,GAAGC,SAAS,CAAA;GACnB,CAAA;AACH;;;;"}