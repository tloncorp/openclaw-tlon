{"version":3,"file":"deep.ts.js","sources":["../src/deep.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/* eslint-disable @typescript-eslint/ban-types */\n\n// import { Signal } from \"signal-polyfill\";\nimport { createStorage, fnCacheFor, type Storage } from \"./-private/util.ts\";\n\n// TODO: see if we can utilize these existing implementations\n//       would these require yet another proxy?\n//       Array clones the whole array and deep object does not\n//       what are tradeoffs? does it matter much?\n// import { SignalObject } from \"./object.ts\";\n// import { SignalArray } from \"./array.ts\";\n\ntype PropertyList = Array<string | number | Symbol>;\ntype TrackedProxy<T> = T;\n\nconst COLLECTION = Symbol(\"__ COLLECTION __\");\n\ntype Key = number | string | symbol;\n\nconst STORAGES_CACHE = new WeakMap<\n  object | Array<unknown>,\n  // The tracked storage for an object or array.\n  // ie: TrackedArray, TrackedObject, but all in one\n  Map<Key, Storage>\n>();\n\nfunction ensureStorages(context: any) {\n  let existing = STORAGES_CACHE.get(context);\n\n  if (!existing) {\n    existing = new Map();\n    STORAGES_CACHE.set(context, existing);\n  }\n\n  return existing;\n}\n\nfunction storageFor(context: any, key: Key) {\n  let storages = ensureStorages(context);\n\n  return storages.get(key);\n}\n\nexport function initStorage(context: any, key: Key, initialValue: any = null) {\n  let storages = ensureStorages(context);\n\n  let initialStorage = createStorage(initialValue);\n\n  storages.set(key, initialStorage);\n\n  return initialStorage.get();\n}\n\nexport function hasStorage(context: any, key: Key) {\n  return Boolean(storageFor(context, key));\n}\n\nexport function readStorage(context: any, key: Key) {\n  let storage = storageFor(context, key);\n\n  if (storage === undefined) {\n    return initStorage(context, key, null);\n  }\n\n  return storage.get();\n}\n\nexport function updateStorage(context: any, key: Key, value: any = null) {\n  let storage = storageFor(context, key);\n\n  if (!storage) {\n    initStorage(context, key, value);\n\n    return;\n  }\n\n  storage.set(value);\n}\n\nexport function readCollection(context: any) {\n  if (!hasStorage(context, COLLECTION)) {\n    initStorage(context, COLLECTION, context);\n  }\n\n  return readStorage(context, COLLECTION);\n}\n\nexport function dirtyCollection(context: any) {\n  if (!hasStorage(context, COLLECTION)) {\n    initStorage(context, COLLECTION, context);\n  }\n\n  return updateStorage(context, COLLECTION, context);\n}\n\n/**\n * Deeply track an Array, and all nested objects/arrays within.\n *\n * If an element / value is ever a non-object or non-array, deep-tracking will exit\n *\n */\nexport function deepSignal<T>(arr: T[]): TrackedProxy<T[]>;\n/**\n * Deeply track an Object, and all nested objects/arrays within.\n *\n * If an element / value is ever a non-object or non-array, deep-tracking will exit\n *\n */\nexport function deepSignal<T extends Record<string, unknown>>(\n  obj: T,\n): TrackedProxy<T>;\n/**\n * Deeply track an Object or Array, and all nested objects/arrays within.\n *\n * If an element / value is ever a non-object or non-array, deep-tracking will exit\n *\n */\nexport function deepSignal(...args: any): any;\n\nexport function deepSignal(...[target, context]: any[]): unknown {\n  if (\"kind\" in context) {\n    if (context.kind === \"accessor\") {\n      return deepTrackedForDescriptor(target, context);\n    }\n\n    throw new Error(`Decorators of kind ${context.kind} are not supported.`);\n  }\n\n  return deep(target);\n}\n\nfunction deepTrackedForDescriptor<Value = any>(\n  target: ClassAccessorDecoratorTarget<unknown, Value>,\n  context: ClassAccessorDecoratorContext,\n): ClassAccessorDecoratorResult<unknown, Value> {\n  const { name: key } = context;\n  const { get } = target;\n\n  return {\n    get(): Value {\n      if (hasStorage(this, key)) {\n        return readStorage(this, key) as Value;\n      }\n\n      let value = get.call(this); // already deep, due to init\n      return initStorage(this, key, value) as Value;\n    },\n\n    set(value: Value) {\n      let deepValue = deep(value);\n      updateStorage(this, key, deepValue);\n      // set.call(this, deepValue);\n      //updateStorage(this, key, deepTracked(value));\n      // SAFETY: does TS not allow us to have a different type internally?\n      //         maybe I did something goofy.\n      //(get.call(this) as Signal.State<Value>).set(value);\n    },\n\n    init(value: Value) {\n      return deep(value);\n    },\n  };\n}\n\nconst TARGET = Symbol(\"TARGET\");\nconst IS_PROXIED = Symbol(\"IS_PROXIED\");\n\nconst SECRET_PROPERTIES: PropertyList = [TARGET, IS_PROXIED];\n\nconst ARRAY_COLLECTION_PROPERTIES = [\"length\"];\nconst ARRAY_CONSUME_METHODS = [\n  Symbol.iterator,\n  \"at\",\n  \"concat\",\n  \"entries\",\n  \"every\",\n  \"filter\",\n  \"find\",\n  \"findIndex\",\n  \"findLast\",\n  \"findLastIndex\",\n  \"flat\",\n  \"flatMap\",\n  \"forEach\",\n  \"group\",\n  \"groupToMap\",\n  \"includes\",\n  \"indexOf\",\n  \"join\",\n  \"keys\",\n  \"lastIndexOf\",\n  \"map\",\n  \"reduce\",\n  \"reduceRight\",\n  \"slice\",\n  \"some\",\n  \"toString\",\n  \"values\",\n  \"length\",\n];\n\nconst ARRAY_DIRTY_METHODS = [\n  \"sort\",\n  \"fill\",\n  \"pop\",\n  \"push\",\n  \"shift\",\n  \"splice\",\n  \"unshift\",\n  \"reverse\",\n];\n\nconst ARRAY_QUERY_METHODS: PropertyList = [\n  \"indexOf\",\n  \"contains\",\n  \"lastIndexOf\",\n  \"includes\",\n];\n\nexport function deep<T>(obj: T | null | undefined): T {\n  if (obj === null || obj === undefined) {\n    return obj as T;\n  }\n\n  if (obj[IS_PROXIED as keyof T]) {\n    return obj;\n  }\n\n  if (Array.isArray(obj)) {\n    return deepProxy(obj, arrayProxyHandler) as unknown as T;\n  }\n\n  if (typeof obj === \"object\") {\n    return deepProxy(obj, objProxyHandler) as unknown as T;\n  }\n\n  return obj;\n}\n\nconst arrayProxyHandler: ProxyHandler<Array<unknown>> = {\n  get<T extends unknown[]>(target: T, property: keyof T, receiver: T) {\n    let value = Reflect.get(target, property, receiver);\n\n    if (property === TARGET) {\n      return value;\n    }\n\n    if (property === IS_PROXIED) {\n      return true;\n    }\n\n    if (typeof property === \"string\") {\n      let parsed = parseInt(property, 10);\n\n      if (!isNaN(parsed)) {\n        // Why consume the collection?\n        // because indices can change if the collection changes\n        readCollection(target);\n        readStorage(target, parsed);\n\n        return deep(value);\n      }\n\n      if (ARRAY_COLLECTION_PROPERTIES.includes(property)) {\n        readCollection(target);\n\n        return value;\n      }\n    }\n\n    if (typeof value === \"function\") {\n      let fnCache = fnCacheFor(target);\n      let existing = fnCache.get(property as KeyType);\n\n      if (!existing) {\n        let fn = (...args: unknown[]) => {\n          if (typeof property === \"string\") {\n            if (ARRAY_QUERY_METHODS.includes(property)) {\n              readCollection(target);\n\n              let fn = target[property];\n\n              if (typeof fn === \"function\") {\n                return fn.call(target, ...args.map(unwrap));\n              }\n            } else if (ARRAY_CONSUME_METHODS.includes(property)) {\n              readCollection(target);\n            } else if (ARRAY_DIRTY_METHODS.includes(property)) {\n              dirtyCollection(target);\n            }\n          }\n\n          return Reflect.apply(value, receiver, args);\n        };\n\n        fnCache.set(property as KeyType, fn);\n\n        return fn;\n      }\n\n      return existing;\n    }\n\n    return value;\n  },\n  set(target, property, value, receiver) {\n    if (typeof property === \"string\") {\n      let parsed = parseInt(property, 10);\n\n      if (!isNaN(parsed)) {\n        updateStorage(target, property, value);\n        // when setting, the collection must be dirtied.. :(\n        // this is to support updating {{#each}},\n        // which uses object identity by default\n        dirtyCollection(target);\n\n        return Reflect.set(target, property, value, receiver);\n      } else if (property === \"length\") {\n        dirtyCollection(target);\n\n        return Reflect.set(target, property, value, receiver);\n      }\n    }\n\n    dirtyCollection(target);\n\n    return Reflect.set(target, property, value, receiver);\n  },\n  has(target, property) {\n    if (SECRET_PROPERTIES.includes(property)) {\n      return true;\n    }\n\n    readStorage(target, property);\n\n    return property in target;\n  },\n  getPrototypeOf() {\n    return Array.prototype;\n  },\n};\n\nconst objProxyHandler = {\n  get<T extends object>(target: T, prop: keyof T, receiver: T) {\n    if (prop === TARGET) {\n      return target;\n    }\n\n    if (prop === IS_PROXIED) {\n      return true;\n    }\n\n    readStorage(target, prop);\n\n    return deep(Reflect.get(target, prop, receiver));\n  },\n  has<T extends object>(target: T, prop: keyof T) {\n    if (SECRET_PROPERTIES.includes(prop)) {\n      return true;\n    }\n\n    readStorage(target, prop);\n\n    return prop in target;\n  },\n\n  ownKeys<T extends object>(target: T) {\n    readCollection(target);\n\n    return Reflect.ownKeys(target);\n  },\n\n  set<T extends object>(\n    target: T,\n    prop: keyof T,\n    value: T[keyof T],\n    receiver: T,\n  ) {\n    updateStorage(target, prop);\n    dirtyCollection(target);\n\n    return Reflect.set(target, prop, value, receiver);\n  },\n\n  getPrototypeOf() {\n    return Object.prototype;\n  },\n};\n\nconst PROXY_CACHE = new WeakMap<any, object>();\n\nfunction unwrap<T>(obj: T) {\n  if (typeof obj === \"object\" && obj && TARGET in obj) {\n    return obj[TARGET as keyof T];\n  }\n\n  return obj;\n}\n\nfunction deepProxy<T extends object>(\n  obj: T,\n  handler: ProxyHandler<T>,\n): TrackedProxy<T> {\n  let existing = PROXY_CACHE.get(obj);\n\n  if (existing) {\n    return existing as T;\n  }\n\n  let proxied = new Proxy(obj, handler);\n\n  PROXY_CACHE.set(obj, proxied);\n\n  return proxied as T;\n}\n"],"names":["COLLECTION","Symbol","STORAGES_CACHE","WeakMap","ensureStorages","context","existing","get","Map","set","storageFor","key","storages","initStorage","initialValue","initialStorage","createStorage","hasStorage","Boolean","readStorage","storage","undefined","updateStorage","value","readCollection","dirtyCollection","deepSignal","target","kind","deepTrackedForDescriptor","Error","deep","name","call","deepValue","init","TARGET","IS_PROXIED","SECRET_PROPERTIES","ARRAY_COLLECTION_PROPERTIES","ARRAY_CONSUME_METHODS","iterator","ARRAY_DIRTY_METHODS","ARRAY_QUERY_METHODS","obj","Array","isArray","deepProxy","arrayProxyHandler","objProxyHandler","property","receiver","Reflect","parsed","parseInt","isNaN","includes","fnCache","fnCacheFor","fn","args","map","unwrap","apply","has","getPrototypeOf","prototype","prop","ownKeys","Object","PROXY_CACHE","handler","proxied","Proxy"],"mappings":"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"}