{"version":3,"file":"async-function.ts.js","sources":["../src/async-function.ts"],"sourcesContent":["import { Signal } from \"signal-polyfill\";\nimport { SignalAsyncData } from \"./async-data.ts\";\n\n/**\n * Any tracked data accessed in a tracked function _before_ an `await`\n * will \"entangle\" with the function -- we can call these accessed tracked\n * properties, the \"tracked prelude\". If any properties within the tracked\n * payload  change, the function will re-run.\n */\nexport function signalFunction<Return>(fn: () => Return): State<Return> {\n  if (arguments.length === 1) {\n    if (typeof fn !== \"function\") {\n      throw new Error(\"signalFunction must be called with a function passed\");\n    }\n    return new State(fn);\n  }\n\n  throw new Error(\n    \"Unknown arity: signalFunction must be called with 1 argument\",\n  );\n}\n\n/**\n * State container that represents the asynchrony of a `signalFunction`\n */\nexport class State<Value> {\n  #data = new Signal.State<SignalAsyncData<Value> | null>(null);\n  get data() {\n    this.#computed.get();\n    return this.#data.get();\n  }\n\n  #promise = new Signal.State<Value | undefined>(undefined);\n  get promise() {\n    this.#computed.get();\n    return this.#promise.get();\n  }\n\n  /**\n   * ember-async-data doesn't catch errors,\n   * so we can't rely on it to protect us from \"leaky errors\"\n   * during rendering.\n   *\n   * See also: https://github.com/qunitjs/qunit/issues/1736\n   */\n  #caughtError = new Signal.State<unknown>(undefined);\n  get caughtError() {\n    this.#computed.get();\n    return this.#caughtError.get();\n  }\n\n  #fn: () => Value;\n\n  #computed: Signal.Computed<this>;\n\n  constructor(fn: () => Value) {\n    this.#fn = fn;\n    this.#computed = new Signal.Computed(() => {\n      this.retry();\n      return this;\n    });\n  }\n\n  get state(): \"PENDING\" | \"RESOLVED\" | \"REJECTED\" | \"UNSTARTED\" {\n    this.#computed.get();\n    return this.data?.state ?? \"UNSTARTED\";\n  }\n\n  /**\n   * Initially true, and remains true\n   * until the underlying promise resolves or rejects.\n   */\n  get isPending() {\n    this.#computed.get();\n    if (!this.data) return true;\n\n    return this.data.isPending ?? false;\n  }\n\n  /**\n   * Alias for `isResolved || isRejected`\n   */\n  get isFinished() {\n    this.#computed.get();\n    return this.isResolved || this.isRejected;\n  }\n\n  /**\n   * Alias for `isFinished`\n   * which is in turn an alias for `isResolved || isRejected`\n   */\n  get isSettled() {\n    this.#computed.get();\n    return this.isFinished;\n  }\n\n  /**\n   * Alias for `isPending`\n   */\n  get isLoading() {\n    this.#computed.get();\n    return this.isPending;\n  }\n\n  /**\n   * When true, the function passed to `signalFunction` has resolved\n   */\n  get isResolved() {\n    this.#computed.get();\n    return this.data?.isResolved ?? false;\n  }\n\n  /**\n   * Alias for `isRejected`\n   */\n  get isError() {\n    this.#computed.get();\n    return this.isRejected;\n  }\n\n  /**\n   * When true, the function passed to `signalFunction` has errored\n   */\n  get isRejected() {\n    this.#computed.get();\n    return this.data?.isRejected ?? Boolean(this.caughtError) ?? false;\n  }\n\n  /**\n   * this.data may not exist yet.\n   *\n   * Additionally, prior iterations of TrackedAsyncData did\n   * not allow the accessing of data before\n   * .state === 'RESOLVED'  (isResolved).\n   *\n   * From a correctness standpoint, this is perfectly reasonable,\n   * as it forces folks to handle the states involved with async functions.\n   *\n   * The original version of `signalFunction` did not use TrackedAsyncData,\n   * and did not have these strictnesses upon property access, leaving folks\n   * to be as correct or as fast/prototype-y as they wished.\n   *\n   * For now, `signalFunction` will retain that flexibility.\n   */\n  get value(): Awaited<Value> | null {\n    this.#computed.get();\n    if (this.data?.isResolved) {\n      // This is sort of a lie, but it ends up working out due to\n      // how promises chain automatically when awaited\n      return this.data.value as Awaited<Value>;\n    }\n\n    return null;\n  }\n\n  /**\n   * When the function passed to `signalFunction` throws an error,\n   * that error will be the value returned by this property\n   */\n  get error() {\n    this.#computed.get();\n    if (this.state === \"UNSTARTED\" && this.caughtError) {\n      return this.caughtError;\n    }\n\n    if (this.data?.state !== \"REJECTED\") {\n      return null;\n    }\n\n    if (this.caughtError) {\n      return this.caughtError;\n    }\n\n    return this.data?.error ?? null;\n  }\n\n  /**\n   * Will re-invoke the function passed to `signalFunction`\n   * this will also re-set some properties on the `State` instance.\n   * This is the same `State` instance as before, as the `State` instance\n   * is tied to the `fn` passed to `signalFunction`\n   *\n   * `error` or `resolvedValue` will remain as they were previously\n   * until this promise resolves, and then they'll be updated to the new values.\n   */\n  retry = async () => {\n    try {\n      /**\n       * This function has two places where it can error:\n       * - immediately when inovking `fn` (where auto-tracking occurs)\n       * - after an await, \"eventually\"\n       */\n      await this.#dangerousRetry();\n    } catch (e) {\n      this.#caughtError.set(e);\n    }\n  };\n\n  async #dangerousRetry() {\n    // We've previously had data, but we're about to run-again.\n    // we need to do this again so `isLoading` goes back to `true` when re-running.\n    // NOTE: we want to do this _even_ if this.data is already null.\n    //       it's all in the same tracking frame and the important thing is that\n    //       we can't *read* data here.\n    this.#data.set(null);\n\n    // We need to invoke this before going async so that tracked properties are\n    // consumed (entangled with) synchronously\n    this.#promise.set(this.#fn());\n\n    // TrackedAsyncData interacts with tracked data during instantiation.\n    // We don't want this internal state to entangle with `signalFunction`\n    // so that *only* the tracked data in `fn` can be entangled.\n    await Promise.resolve();\n\n    /**\n     * Before we await to start a new request, let's clear our error.\n     * This is detached from the tracking frame (via the above await),\n     * se the UI can update accordingly, without causing us to refetch\n     */\n    this.#caughtError.set(null);\n    this.#data.set(new SignalAsyncData<Value>(this.promise!));\n\n    return this.promise;\n  }\n}\n"],"names":["signalFunction","fn","arguments","length","Error","State","Signal","data","get","undefined","promise","caughtError","constructor","Computed","retry","state","isPending","isFinished","isResolved","isRejected","isSettled","isLoading","isError","Boolean","value","error","e","set","#dangerousRetry","Promise","resolve","SignalAsyncData"],"mappings":"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"}