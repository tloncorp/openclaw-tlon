{"version":3,"file":"local-copy.ts.js","sources":["../src/local-copy.ts"],"sourcesContent":["import { signal } from \"./index.ts\";\n\nclass Meta<Value> {\n  prevRemote?: Value;\n  peek?: () => Value;\n  @signal accessor value: Value | undefined;\n}\n\nfunction getOrCreateMeta<Value>(\n  instance: WeakKey,\n  metas: WeakMap<WeakKey, Meta<Value>>,\n  initializer?: Value | Function,\n) {\n  let meta = metas.get(instance);\n\n  if (meta === undefined) {\n    meta = new Meta<Value>();\n    metas.set(instance, meta);\n\n    meta.value = meta.peek =\n      typeof initializer === \"function\"\n        ? initializer.call(instance)\n        : initializer;\n  }\n\n  return meta;\n}\n\nfunction get(obj: any, path: string) {\n  let current = obj;\n  let parts = path.split(\".\");\n\n  for (let part of parts) {\n    if (!current) return current;\n\n    if (!(part in current)) {\n      throw new Error(\n        `sub-path ${part} (from ${path}) does not exist on ${JSON.stringify(current)}.`,\n      );\n    }\n\n    current = current[part];\n  }\n\n  return current;\n}\n\n/**\n * Forks remote state for local modification\n *\n * ```js\n * import { Signal } from 'signal-polyfill';\n * import { localCopy } from 'signal-utils';\n *\n * const remote = new Signal.State(0);\n *\n * const local = localCopy(() => remote.get());\n * ```\n */\nexport function localCopy<Value = any>(\n  fn: () => Value,\n): { get(): Value; set(v: Value): void };\n\n/**\n * Forks remote state for local modification\n *\n * ```js\n * import { localCopy } from 'signal-utils';\n *\n * class Demo {\n *    @localCopy('remote.value') accessor localValue;\n * }\n * ```\n */\nexport function localCopy<Value = any, This extends WeakKey = WeakKey>(\n  memo: string,\n  initializer?: Value | (() => Value),\n): (\n  _target: ClassAccessorDecoratorTarget<This, Value>,\n  _context: ClassAccessorDecoratorContext<This, Value>,\n) => ClassAccessorDecoratorResult<This, Value>;\n\n/**\n * Forks remote state for local modification\n *\n * ```js\n * import { localCopy } from 'signal-utils';\n *\n * class Demo {\n *    @localCopy('remote.value') accessor localValue;\n * }\n * ```\n */\nexport function localCopy<Value = any, This extends WeakKey = WeakKey>(\n  ...args: any[]\n) {\n  if (typeof args[0] === \"function\") {\n    return localCopyFn<Value, This>(args[0]);\n  }\n\n  let [first, second] = args;\n\n  return localCopyDecorator<Value, This>(\n    first,\n    second as undefined | Value | (() => Value),\n  );\n}\n\nfunction localCopyFn<Value = any, This extends WeakKey = WeakKey>(\n  memoFn: () => Value,\n) {\n  let metas = new WeakMap<WeakKey, Meta<Value>>();\n\n  return {\n    get(this: This): Value {\n      let meta = getOrCreateMeta<Value>(this, metas);\n      let { prevRemote } = meta;\n\n      let incomingValue = memoFn();\n\n      if (prevRemote !== incomingValue) {\n        // If the incoming value is not the same as the previous incoming value,\n        // update the local value to match the new incoming value, and update\n        // the previous incoming value.\n        meta.value = meta.prevRemote = incomingValue;\n      }\n\n      return meta.value as Value;\n    },\n\n    set(this: WeakKey, value: Value) {\n      if (!metas.has(this)) {\n        let meta = getOrCreateMeta(this, metas);\n        meta.prevRemote = memoFn();\n        meta.value = value;\n        return;\n      }\n\n      getOrCreateMeta(this, metas).value = value;\n    },\n  };\n}\n\nfunction localCopyDecorator<Value = any, This extends WeakKey = WeakKey>(\n  memo: string,\n  initializer: undefined | Value | (() => Value),\n) {\n  if (typeof memo !== \"string\") {\n    throw new Error(\n      `@localCopy() must be given a memo path as its first argument, received \\`${String(\n        memo,\n      )}\\``,\n    );\n  }\n\n  let metas = new WeakMap<WeakKey, Meta<Value>>();\n\n  return function localCopyDecorator(\n    _target: ClassAccessorDecoratorTarget<This, Value>,\n    _context: ClassAccessorDecoratorContext<This, Value>,\n  ): ClassAccessorDecoratorResult<This, Value> {\n    let memoFn = (obj: any) => get(obj, memo);\n\n    return {\n      get(this: This): Value {\n        let meta = getOrCreateMeta<Value>(this, metas, initializer);\n        let { prevRemote } = meta;\n\n        let incomingValue = memoFn(this);\n\n        if (prevRemote !== incomingValue) {\n          // If the incoming value is not the same as the previous incoming value,\n          // update the local value to match the new incoming value, and update\n          // the previous incoming value.\n          meta.value = meta.prevRemote = incomingValue;\n        }\n\n        return meta.value as Value;\n      },\n\n      set(this: WeakKey, value: Value) {\n        if (!metas.has(this)) {\n          let meta = getOrCreateMeta(this, metas, initializer);\n          meta.prevRemote = memoFn(this);\n          meta.value = value;\n          return;\n        }\n\n        getOrCreateMeta(this, metas, initializer).value = value;\n      },\n    };\n  };\n}\n"],"names":["Meta","_init_value","_init_extra_value","_applyDecs","signal","e","constructor","prevRemote","peek","value","v","A","getOrCreateMeta","instance","metas","initializer","meta","get","undefined","set","call","obj","path","current","parts","split","part","Error","JSON","stringify","localCopy","args","localCopyFn","first","second","localCopyDecorator","memoFn","WeakMap","incomingValue","has","memo","String","_target","_context"],"mappings":"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"}