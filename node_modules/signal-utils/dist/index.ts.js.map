{"version":3,"file":"index.ts.js","sources":["../src/index.ts"],"sourcesContent":["import { Signal } from \"signal-polyfill\";\n\n/**\n * Usage:\n * ```js\n * export class Counter {\n *   @signal accessor #value = 0;\n *\n *   get doubled() {\n *     return this.#value * 2;\n *   }\n *\n *   increment() {\n *     this.#value++;\n *   }\n *\n *   decrement() {\n *     if (this.#value > 0) {\n *       this.#value--;\n *     }\n *   }\n * }\n * ```\n */\nexport function signal<Value = any>(\n  ...args: Parameters<typeof stateDecorator<Value>>\n): ReturnType<typeof stateDecorator<Value>>;\n\n/**\n * Usage:\n * ```js\n * import { signal } from 'signal-utils';\n *\n * export class Counter {\n *   @signal accessor #value = 0;\n *\n *   @signal\n *   get expensive() {\n *     // some expensive operation\n *     return this.#value * 2;\n *   }\n *\n *   increment() {\n *     this.#value++;\n *   }\n * }\n * ```\n */\nexport function signal<Value = any>(\n  ...args: Parameters<typeof computedDecorator<Value>>\n): ReturnType<typeof computedDecorator<Value>>;\n\nexport function signal<Value = any>(\n  ...args:\n    | Parameters<typeof stateDecorator<Value>>\n    | Parameters<typeof computedDecorator<Value>>\n) {\n  if (args[1].kind === \"accessor\") {\n    return stateDecorator(\n      ...(args as Parameters<typeof stateDecorator<Value>>),\n    );\n  }\n\n  if (args[1].kind === \"getter\") {\n    return computedDecorator(\n      ...(args as Parameters<typeof computedDecorator<Value>>),\n    );\n  }\n\n  throw new Error(`@signal can only be used on accessors or getters`);\n}\n\nfunction stateDecorator<Value = any>(\n  target: ClassAccessorDecoratorTarget<unknown, Value>,\n  context: ClassAccessorDecoratorContext,\n): ClassAccessorDecoratorResult<unknown, Value> {\n  const { get } = target;\n\n  if (context.kind !== \"accessor\") {\n    throw new Error(`Expected to be used on an accessor property`);\n  }\n\n  return {\n    get(): Value {\n      // SAFETY: does TS not allow us to have a different type internally?\n      //         maybe I did something goofy.\n      return (get.call(this) as Signal.State<Value>).get();\n    },\n\n    set(value: Value) {\n      // SAFETY: does TS not allow us to have a different type internally?\n      //         maybe I did something goofy.\n      (get.call(this) as Signal.State<Value>).set(value);\n    },\n\n    init(value: Value) {\n      // SAFETY: does TS not allow us to have a different type internally?\n      //         maybe I did something goofy.\n      return new Signal.State(value) as unknown as Value;\n    },\n  };\n}\n\nfunction computedDecorator<Value = any>(\n  target: () => Value,\n  context: ClassGetterDecoratorContext,\n): () => Value {\n  const kind = context.kind;\n\n  if (kind !== \"getter\") {\n    throw new Error(`Can only use @cached on getters.`);\n  }\n\n  const caches = new WeakMap<\n    typeof target,\n    WeakMap<object, Signal.Computed<Value>>\n  >();\n\n  return function (this: unknown) {\n    let cache = caches.get(target);\n    if (!cache) {\n      cache = new WeakMap();\n      caches.set(target, cache);\n    }\n    let effect = cache.get(this as object);\n    if (!effect) {\n      effect = new Signal.Computed(() => target.call(this));\n      cache.set(this as object, effect);\n    }\n\n    return effect.get();\n  };\n}\n"],"names":["signal","args","kind","stateDecorator","computedDecorator","Error","target","context","get","call","set","value","init","Signal","State","caches","WeakMap","cache","effect","Computed"],"mappings":";;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAKO,SAASA,MAAMA,CACpB,GAAGC,IAE4C,EAC/C;EACA,IAAIA,IAAI,CAAC,CAAC,CAAC,CAACC,IAAI,KAAK,UAAU,EAAE;AAC/B,IAAA,OAAOC,cAAc,CACnB,GAAIF,IACN,CAAC,CAAA;AACH,GAAA;EAEA,IAAIA,IAAI,CAAC,CAAC,CAAC,CAACC,IAAI,KAAK,QAAQ,EAAE;AAC7B,IAAA,OAAOE,iBAAiB,CACtB,GAAIH,IACN,CAAC,CAAA;AACH,GAAA;AAEA,EAAA,MAAM,IAAII,KAAK,CAAE,CAAA,gDAAA,CAAiD,CAAC,CAAA;AACrE,CAAA;AAEA,SAASF,cAAcA,CACrBG,MAAoD,EACpDC,OAAsC,EACQ;EAC9C,MAAM;AAAEC,IAAAA,GAAAA;AAAI,GAAC,GAAGF,MAAM,CAAA;AAEtB,EAAA,IAAIC,OAAO,CAACL,IAAI,KAAK,UAAU,EAAE;AAC/B,IAAA,MAAM,IAAIG,KAAK,CAAE,CAAA,2CAAA,CAA4C,CAAC,CAAA;AAChE,GAAA;EAEA,OAAO;AACLG,IAAAA,GAAGA,GAAU;AACX;AACA;MACA,OAAQA,GAAG,CAACC,IAAI,CAAC,IAAI,CAAC,CAAyBD,GAAG,EAAE,CAAA;KACrD;IAEDE,GAAGA,CAACC,KAAY,EAAE;AAChB;AACA;MACCH,GAAG,CAACC,IAAI,CAAC,IAAI,CAAC,CAAyBC,GAAG,CAACC,KAAK,CAAC,CAAA;KACnD;IAEDC,IAAIA,CAACD,KAAY,EAAE;AACjB;AACA;AACA,MAAA,OAAO,IAAIE,MAAM,CAACC,KAAK,CAACH,KAAK,CAAC,CAAA;AAChC,KAAA;GACD,CAAA;AACH,CAAA;AAEA,SAASP,iBAAiBA,CACxBE,MAAmB,EACnBC,OAAoC,EACvB;AACb,EAAA,MAAML,IAAI,GAAGK,OAAO,CAACL,IAAI,CAAA;EAEzB,IAAIA,IAAI,KAAK,QAAQ,EAAE;AACrB,IAAA,MAAM,IAAIG,KAAK,CAAE,CAAA,gCAAA,CAAiC,CAAC,CAAA;AACrD,GAAA;AAEA,EAAA,MAAMU,MAAM,GAAG,IAAIC,OAAO,EAGvB,CAAA;AAEH,EAAA,OAAO,YAAyB;AAC9B,IAAA,IAAIC,KAAK,GAAGF,MAAM,CAACP,GAAG,CAACF,MAAM,CAAC,CAAA;IAC9B,IAAI,CAACW,KAAK,EAAE;AACVA,MAAAA,KAAK,GAAG,IAAID,OAAO,EAAE,CAAA;AACrBD,MAAAA,MAAM,CAACL,GAAG,CAACJ,MAAM,EAAEW,KAAK,CAAC,CAAA;AAC3B,KAAA;AACA,IAAA,IAAIC,MAAM,GAAGD,KAAK,CAACT,GAAG,CAAC,IAAc,CAAC,CAAA;IACtC,IAAI,CAACU,MAAM,EAAE;AACXA,MAAAA,MAAM,GAAG,IAAIL,MAAM,CAACM,QAAQ,CAAC,MAAMb,MAAM,CAACG,IAAI,CAAC,IAAI,CAAC,CAAC,CAAA;AACrDQ,MAAAA,KAAK,CAACP,GAAG,CAAC,IAAI,EAAYQ,MAAM,CAAC,CAAA;AACnC,KAAA;AAEA,IAAA,OAAOA,MAAM,CAACV,GAAG,EAAE,CAAA;GACpB,CAAA;AACH;;;;"}