!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UrbitHttpApi={})}(this,(function(t){"use strict";class e extends Error{}class s extends Error{}class n extends Error{}var i={};Object.defineProperty(i,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r="undefined"!=typeof window&&void 0!==window.document,a="object"===("undefined"==typeof self?"undefined":o(self))&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,d="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,c=i.isBrowser=r;i.isWebWorker=a;var h=i.isNode=d;function u(t){let e,s,n,i=!1;return function(o){void 0===e?(e=o,s=0,n=-1):e=function(t,e){const s=new Uint8Array(t.length+e.length);return s.set(t),s.set(e,t.length),s}(e,o);const r=e.length;let a=0;for(;s<r;){i&&(10===e[s]&&(a=++s),i=!1);let o=-1;for(;s<r&&-1===o;++s)switch(e[s]){case 58:-1===n&&(n=s-a);break;case 13:i=!0;case 10:o=s}if(-1===o)break;t(e.subarray(a,o),n),a=s,n=-1}a===r?e=void 0:0!==a&&(e=e.subarray(a),s-=a)}}i.isJsDom=function(){return"undefined"!=typeof window&&"nodejs"===window.name||navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")};const l="text/event-stream",p=1e3,f="last-event-id";function g(t,{signal:e,headers:s,onopen:i,onmessage:o,onclose:r,onerror:a,openWhenHidden:d,fetch:c,responseTimeout:h,...g}){return new Promise(((m,w)=>{const v={...s};let y;function E(){y.abort(),document.hidden||C()}v.accept||(v.accept=l),"undefined"==typeof document||d||document.addEventListener("visibilitychange",E);let k,S=p;function I(){"undefined"==typeof document||d||document.removeEventListener("visibilitychange",E),clearTimeout(k),y.abort()}e?.addEventListener("abort",(()=>{I(),m()}));const O=c??fetch,P=i??b;let $=!1;async function C(){y=new AbortController;try{const e=await Promise.race([O(t,{...g,headers:v,signal:y.signal}),new Promise(((t,e)=>{setTimeout((()=>e(new Error("fetch timed out"))),h)}))]);if(404===e.status)return a?.(new n("Channel reaped")),I(),void m();if(e.status<200||e.status>=300)throw new Error(`Invalid server response: ${e.status}`);await P(e,$),$&&($=!1),await async function(t,e,s){const n=t.getReader();let i={done:!1,value:new Uint8Array};for(;i&&!i.done;)i=await Promise.race([n.read(),new Promise(((t,e)=>{setTimeout((()=>e(new Error("getBytes timed out"))),s)}))]),e(i.value)}(e.body,u(function(t,e,s){let n={data:"",event:"",id:"",retry:void 0};const i=new TextDecoder;return function(o,r){if(0===o.length)t?.(n),n={data:"",event:"",id:"",retry:void 0};else if(r>0){const t=i.decode(o.subarray(0,r)),a=r+(32===o[r+1]?2:1),d=i.decode(o.subarray(a));switch(t){case"data":n.data=n.data?n.data+"\n"+d:d;break;case"event":n.event=d;break;case"id":e?.(n.id=d);break;case"retry":const t=parseInt(d,10);isNaN(t)||s?.(n.retry=t)}}}}(o,(t=>{t?v[f]=t:delete v[f]}),(t=>{S=t}))),h),r?.(),I(),m()}catch(t){if(!y.signal.aborted)try{$=!0;const e=a?.(t)??S;clearTimeout(k),y.abort(),k=setTimeout(C,e)}catch(t){I(),w(t)}}}C()}))}function b(t){const e=t.headers.get("content-type");if(!e?.startsWith(l))throw new Error(`Expected content-type to be ${l}, Actual: ${e}`)}function m(t){const e=Math.pow(16,Math.min(t,8)-1),s=Math.pow(16,Math.min(t,8))-1;let n=(Math.floor(Math.random()*(s-e+1))+e).toString(16);for(;n.length<t;)n+=m(t-8);return n}class w{listeners={};on(t,e){return this.listeners.hasOwnProperty(t)||(this.listeners[t]=[]),this.listeners[t].push(e),this}emit(t,...e){if(!this.listeners.hasOwnProperty(t))return null;for(let s=0;s<this.listeners[t].length;s++){this.listeners[t][s].call(this,...e)}}}class v{url;code;desk;emitter=new w;uid=`${Math.floor(Date.now()/1e3)}-${m(6)}`;lastEventId=0;lastHeardEventId=-1;lastAcknowledgedEventId=-1;sseClientInitialized=!1;cookie;outstandingPokes=new Map;outstandingSubscriptions=new Map;abort=new AbortController;ship;our;verbose;errorCount=0;onError=null;onRetry=null;onOpen=null;onReconnect=null;get channelUrl(){return`${this.url}/~/channel/${this.uid}`}get fetchOptions(){const t={"Content-Type":"application/json"};return c||(t.Cookie=this.cookie),{credentials:"include",accept:"*",headers:t,signal:this.abort.signal}}constructor(t,e,s){return this.url=t,this.code=e,this.desk=s,c&&window.addEventListener("beforeunload",this.delete),this}static async authenticate({ship:t,url:e,code:s,verbose:n=!1}){const i=new v(e.startsWith("http")?e:`http://${e}`,s);return i.verbose=n,i.ship=t,await i.connect(),await i.poke({app:"hood",mark:"helm-hi",json:"opening airlock"}),await i.eventSource(),i}emit(t,e){this.verbose&&this.emitter.emit(t,e)}on(t,e){this.emitter.on(t,e),this.verbose&&console.log(t,"listening active"),"init"===t&&this.emitter.emit(t,{uid:this.uid,subscriptions:[...this.outstandingSubscriptions.entries()].map((([t,e])=>({id:t,app:e.app,path:e.path})))})}async getShipName(){if(this.ship)return Promise.resolve();const t=await fetch(`${this.url}/~/host`,{method:"get",credentials:"include"}),e=await t.text();this.ship=e.substring(1)}async getOurName(){if(this.our)return Promise.resolve();const t=await fetch(`${this.url}/~/name`,{method:"get",credentials:"include"}),e=await t.text();this.our=e.substring(1)}async connect(){return this.verbose&&console.log(`password=${this.code} `,c?`Connecting in browser context at ${this.url}/~/login`:"Connecting from node context"),fetch(`${this.url}/~/login`,{method:"post",body:`password=${this.code}`,credentials:"include"}).then((async t=>{if(this.verbose&&console.log("Received authentication response",t),t.status>=200&&t.status<300)throw new Error("Login failed with status "+t.status);const e=t.headers.get("set-cookie");!this.ship&&e&&(this.ship=new RegExp(/urbauth-~([\w-]+)/).exec(e)[1]),c||(this.cookie=e),this.getShipName(),this.getOurName()}))}async eventSource(){return this.sseClientInitialized?Promise.resolve():0===this.lastEventId?(this.emit("status-update",{status:"opening"}),void await this.poke({app:"hood",mark:"helm-hi",json:"Opening API channel"})):(this.sseClientInitialized=!0,new Promise(((t,e)=>{c||h&&this.cookie,g(this.channelUrl,{...this.fetchOptions,openWhenHidden:!0,responseTimeout:25e3,onopen:async(s,n)=>{if(this.verbose&&console.log("Opened eventsource",s),n&&this.onReconnect&&this.onReconnect(),s.ok)return this.errorCount=0,this.onOpen&&this.onOpen(),this.emit("status-update",{status:n?"reconnected":"active"}),void t();{const t=new Error("failed to open eventsource");e(t)}},onmessage:t=>{if(this.verbose&&console.log("Received SSE: ",t),!t.id)return;const e=parseInt(t.id,10);if(this.emit("fact",{id:e,data:t.data,time:Date.now()}),e<=this.lastHeardEventId)this.verbose&&console.log("dropping old or out-of-order event",{eventId:e,lastHeard:this.lastHeardEventId});else if(this.lastHeardEventId=e,this.emit("id-update",{lastHeard:this.lastHeardEventId}),e-this.lastAcknowledgedEventId>20&&this.ack(e),t.data&&JSON.parse(t.data)){const e=JSON.parse(t.data);if("poke"===e.response&&this.outstandingPokes.has(e.id)){const t=this.outstandingPokes.get(e.id);e.hasOwnProperty("ok")?t.onSuccess():e.hasOwnProperty("err")?(console.error(e.err),t.onError(e.err)):console.error("Invalid poke response",e),this.outstandingPokes.delete(e.id)}else if("subscribe"===e.response&&this.outstandingSubscriptions.has(e.id)){const t=this.outstandingSubscriptions.get(e.id);e.hasOwnProperty("err")&&(console.error(e.err),t.err(e.err,e.id),this.outstandingSubscriptions.delete(e.id))}else if("diff"===e.response&&this.outstandingSubscriptions.has(e.id)){const t=this.outstandingSubscriptions.get(e.id);try{t.event(e.json,e.mark??"json",e.id)}catch(t){console.error("Failed to call subscription event callback",t)}}else if("quit"===e.response&&this.outstandingSubscriptions.has(e.id)){this.outstandingSubscriptions.get(e.id).quit(e),this.outstandingSubscriptions.delete(e.id),this.emit("subscription",{id:e.id,status:"close"})}else this.verbose&&(console.log([...this.outstandingSubscriptions.keys()]),console.log("Unrecognized response",e))}},onerror:t=>{if(this.errorCount++,this.emit("error",{time:Date.now(),msg:JSON.stringify(t)}),!(t instanceof n)){if(!(t instanceof s))return this.emit("status-update",{status:"reconnecting"}),this.onRetry&&this.onRetry(),Math.min(5e3,750*Math.pow(2,this.errorCount-1));throw this.emit("status-update",{status:"errored"}),this.onError&&this.onError(t),t}this.seamlessReset()},onclose:()=>{throw console.log("e"),new Error("Ship unexpectedly closed the connection")}})})))}reset(){this.verbose&&console.log("resetting"),this.delete(),this.abort.abort(),this.abort=new AbortController,this.uid=`${Math.floor(Date.now()/1e3)}-${m(6)}`,this.emit("reset",{uid:this.uid}),this.lastEventId=0,this.lastHeardEventId=-1,this.lastAcknowledgedEventId=-1,this.outstandingSubscriptions=new Map,this.outstandingPokes=new Map,this.sseClientInitialized=!1}seamlessReset(){this.uid=`${Math.floor(Date.now()/1e3)}-${m(6)}`,this.emit("seamless-reset",{uid:this.uid}),this.emit("status-update",{status:"initial"}),this.sseClientInitialized=!1,this.lastEventId=0,this.lastHeardEventId=-1,this.lastAcknowledgedEventId=-1;const t=[...this.outstandingSubscriptions.entries()];this.outstandingSubscriptions=new Map,t.forEach((([t,e])=>{e.quit({id:t,response:"quit"}),this.emit("subscription",{id:t,status:"close"})})),this.outstandingPokes.forEach(((t,e)=>{t.onError("Channel was reaped")})),this.outstandingPokes=new Map}getEventId(){return this.lastEventId+=1,this.emit("id-update",{current:this.lastEventId}),this.lastEventId}async ack(t){this.lastAcknowledgedEventId=t,this.emit("id-update",{lastAcknowledged:t});const e={action:"ack","event-id":t};return await this.sendJSONtoChannel(e),t}async sendJSONtoChannel(...t){if(!(await fetch(this.channelUrl,{...this.fetchOptions,method:"PUT",body:JSON.stringify(t)})).ok)throw new Error("Failed to PUT channel");this.sseClientInitialized||(this.verbose&&console.log("initializing event source"),await this.eventSource())}async subscribeOnce(t,e,s){return new Promise((async(n,i)=>{let o=!1,r=null;const a={app:t,path:e,event:(t,e,s)=>{o||(n(t),this.unsubscribe(s))},err:i,quit:()=>{o||i("quit")}};r=await this.subscribe(a),s&&setTimeout((()=>{o||(o=!0,i("timeout"),this.unsubscribe(r))}),s)}))}async poke(t){const{app:e,mark:s,json:n,ship:i,onSuccess:o,onError:r}={onSuccess:()=>{},onError:()=>{},ship:this.ship,...t};0===this.lastEventId&&this.emit("status-update",{status:"opening"});const a={id:this.getEventId(),action:"poke",ship:i,app:e,mark:s,json:n};return this.outstandingPokes.set(a.id,{onSuccess:()=>{o()},onError:t=>{r(t)}}),await this.sendJSONtoChannel(a),a.id}async subscribe(t){const{app:e,path:s,ship:n,err:i,event:o,quit:r}={err:()=>{},event:()=>{},quit:()=>{},ship:this.ship,...t};0===this.lastEventId&&this.emit("status-update",{status:"opening"});const a={id:this.getEventId(),action:"subscribe",ship:n,app:e,path:s};return this.outstandingSubscriptions.set(a.id,{app:e,path:s,err:i,event:o,quit:r}),this.emit("subscription",{id:a.id,app:e,path:s,status:"open"}),await this.sendJSONtoChannel(a),a.id}async unsubscribe(t){return this.sendJSONtoChannel({id:this.getEventId(),action:"unsubscribe",subscription:t}).then((()=>{this.emit("subscription",{id:t,status:"close"}),this.outstandingSubscriptions.delete(t)}))}async delete(){const t=JSON.stringify([{id:this.getEventId(),action:"delete"}]);if(c)navigator.sendBeacon(this.channelUrl,t);else{if(!(await fetch(this.channelUrl,{...this.fetchOptions,method:"POST",body:t})).ok)throw new Error("Failed to DELETE channel in node context")}}async scry(t){const{app:e,path:s}=t,n=await fetch(`${this.url}/~/scry/${e}${s}.json`,this.fetchOptions);return n.ok?await n.json():Promise.reject(n)}async thread(t){const{inputMark:e,outputMark:s,threadName:n,body:i,desk:o=this.desk}=t;if(!o)throw new Error("Must supply desk to run thread from");return(await fetch(`${this.url}/spider/${o}/${e}/${n}/${s}.json`,{...this.fetchOptions,method:"POST",body:JSON.stringify(i)})).json()}static async onArvoNetwork(t,e){const s=`https://${t}.arvo.network`;return await v.authenticate({ship:t,url:s,code:e})}}t.FatalError=s,t.ReapError=n,t.ResumableError=e,t.Urbit=v,t.default=v}));
//# sourceMappingURL=urbit-http-api.min.js.map
